"""
FIRE Planning System - FastAPI Backend
Modern, async API for personalized FIRE planning
"""

from fastapi import FastAPI, HTTPException
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import Optional, List, Dict
import os
from dotenv import load_dotenv
from groq import Groq

load_dotenv()

app = FastAPI(
    title="FIRE Planning API",
    description="AI-powered personalized FIRE planning and career guidance",
    version="1.0.0"
)

# CORS for Next.js frontend
app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:3000"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# Groq client
client = Groq(api_key=os.getenv('GROQ_API_KEY'))

# ============ MODELS ============

class UserProfile(BaseModel):
    # Basic Info
    name: str
    age: int
    university: str
    major: str
    grad_year: str
    location: str
    relocation_ok: str

    # Current Status
    current_job: str
    current_salary: Optional[str] = "0"
    job_satisfaction: Optional[str] = "0"
    years_current_job: Optional[str] = "0"
    industry: Optional[str] = "none"
    company_size: Optional[str] = "none"

    # Skills
    programming_langs: str
    prog_level: str
    ml_exp: str
    frameworks: str
    cloud_exp: str
    data_tools: str
    github_projects: str
    certifications: str

    # Education - Basic
    considering_masters: str

    # Education - Detailed (conditional)
    masters_fields_interested: Optional[str] = ""
    masters_location_preference: Optional[str] = ""
    masters_program_language: Optional[str] = ""
    masters_type: Optional[str] = ""
    can_afford_masters: Optional[str] = ""
    masters_timeline: Optional[str] = ""
    masters_work_while_study: Optional[str] = ""
    masters_priority: Optional[str] = ""
    masters_specific_programs: Optional[str] = ""
    masters_concerns: Optional[str] = ""

    # Career Goals
    dream_job: str
    dream_salary: str
    target_years: str
    career_path_preference: str
    willing_to_study: str

    # Financial
    monthly_expenses: str
    savings: str
    monthly_savings_goal: str
    debts: str
    family_support: str
    risk_tolerance: str

    # FIRE Vision
    retire_age: str
    fire_lifestyle: str
    retirement_location: str
    passive_income_interest: str

    # Side Hustle
    time_for_side: str
    side_interests: str
    freelance_exp: str
    preferred_side_income: str
    monthly_side_income_goal: str

    # Constraints & Preferences
    time_commit: str
    learning_style: str
    work_life_balance: str
    biggest_obstacle: str
    need_most: str

class AnalysisRequest(BaseModel):
    profile: UserProfile
    analysis_type: str  # "career" | "roi" | "fire" | "side_hustle"

class AnalysisResponse(BaseModel):
    analysis: str
    analysis_type: str
    timestamp: str

# ============ AI HELPERS ============

def call_ai(prompt: str, system: str) -> str:
    """Call Groq API"""
    try:
        response = client.chat.completions.create(
            model="llama-3.3-70b-versatile",
            messages=[
                {"role": "system", "content": system},
                {"role": "user", "content": prompt}
            ],
            temperature=0.7,
            max_tokens=4096
        )
        return response.choices[0].message.content
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"AI Error: {str(e)}")

# ============ ANALYSIS FUNCTIONS ============

def analyze_career(profile: UserProfile) -> str:
    """Generate career path analysis"""
    system = "You are an experienced career coach. You provide CLEAR and ACTIONABLE roadmaps for indecisive people."

    prompt = f"""DETAILED PERSONAL CAREER ANALYSIS:

ðŸ‘¤ PERSON:
- {profile.name}, {profile.age} years old, {profile.university} {profile.major} ({profile.grad_year})
- Location: {profile.location}, Open to relocation: {profile.relocation_ok}
- Biggest obstacle: {profile.biggest_obstacle}, What they need most: {profile.need_most}

ðŸ’¼ CURRENT SITUATION:
- Position: {profile.current_job} (${profile.current_salary}/year)
- Satisfaction: {profile.job_satisfaction}/10, Experience: {profile.years_current_job}
- Industry: {profile.industry}, Company size: {profile.company_size}

ðŸ› ï¸ SKILLS:
- Languages: {profile.programming_langs} (Level: {profile.prog_level})
- ML/AI: {profile.ml_exp}, Frameworks: {profile.frameworks}
- Cloud: {profile.cloud_exp}, Data Tools: {profile.data_tools}
- GitHub: {profile.github_projects}, Certifications: {profile.certifications}

ðŸŽ“ EDUCATION:
- Master's consideration: {profile.considering_masters}
- Fields interested: {profile.masters_fields_interested}
- Location preference: {profile.masters_location_preference}
- Can afford: {profile.can_afford_masters}

ðŸŽ¯ GOALS:
- Dream role: {profile.dream_job}
- Target salary: ${profile.dream_salary}/year (in {profile.target_years} years)
- Career path preference: {profile.career_path_preference}
- Work-life balance importance: {profile.work_life_balance}
- Learning commitment: {profile.time_commit} hours/week
- Learning style: {profile.learning_style}

CREATE DETAILED CAREER PLAN (Markdown format):

## 1ï¸âƒ£ Current Situation Analysis
- **Strengths** (3 points)
- **Gaps/Risks** (3 points)
- **Master's Decision**: Should they do it? (clear reasoning)

## 2ï¸âƒ£ Step-by-Step Roadmap
- **First 3 Months**: Concrete actions
- **6-12 Months**: Skills/Certifications
- **1-2 Years**: Position changes
- **3-5 Years**: Reaching target role

## 3ï¸âƒ£ Priority Skills
- Immediate (1-3 months)
- Mid-term (3-12 months)
- Long-term (1-2 years)

## 4ï¸âƒ£ Projects & Certifications
- 3 project recommendations
- 2-3 certifications (prioritized)

## 5ï¸âƒ£ Salary & Timeline Projection
| Year | Position | Salary | Notes |
|------|----------|--------|-------|
| 0 | {profile.current_job} | ${profile.current_salary} | Now |
| ... | ... | ... | ... |

## 6ï¸âƒ£ Risks & Plan B
- Failure probability
- Things to watch out for
- Alternative plan

CLEAR, ACTIONABLE, Max 50 lines."""

    return call_ai(prompt, system)

def analyze_roi(profile: UserProfile) -> str:
    """Generate ULTRA DETAILED education ROI analysis with program recommendations"""
    system = "Sen dÃ¼nya Ã§apÄ±nda eÄŸitim danÄ±ÅŸmanÄ± ve finansal analistisin. KararsÄ±z insanlara DETAYLI SENARYO ANALÄ°ZÄ° ve SOMUT PROGRAM Ã–NERÄ°LERÄ° veriyorsun."

    years_left = int(profile.retire_age) - int(profile.age)
    current_age = int(profile.age)

    prompt = f"""ULTRA DETAYLI EÄžÄ°TÄ°M & MASTER ANALÄ°ZÄ° + PROGRAM Ã–NERÄ°LERÄ°

ðŸ‘¤ KÄ°ÅžÄ°:
- {profile.name}, {current_age} yaÅŸ, {profile.university} {profile.major}
- Master: {profile.considering_masters}
- Ä°lgi alanlarÄ±: {profile.masters_fields_interested}
- Lokasyon tercihi: {profile.masters_location_preference}
- Dil: {profile.masters_program_language}
- TÃ¼r: {profile.masters_type}
- BÃ¼tÃ§e: {profile.can_afford_masters}
- Zaman: {profile.masters_timeline}
- Ã‡alÄ±ÅŸma durumu: {profile.masters_work_while_study}
- Ã–ncelik: {profile.masters_priority}
- AklÄ±ndaki programlar: {profile.masters_specific_programs}
- EndiÅŸeler: {profile.masters_concerns}

ðŸ’° FÄ°NANSAL:
- Mevcut: ${profile.current_salary}, Birikim: ${profile.savings}
- Hedef: {profile.dream_job} - ${profile.target_salary}
- FIRE: {years_left} yÄ±lda ${profile.target_portfolio}
- Risk: {profile.risk_tolerance}

## 1ï¸âƒ£ MASTER YAPMA KARARI ANALÄ°ZÄ°

### Senin Ä°Ã§in Master Gerekli Mi?
- {profile.dream_job} iÃ§in master **ÅžART MI** yoksa **BONUS MU**?
- Master OLMADAN bu pozisyona ulaÅŸmak mÃ¼mkÃ¼n mÃ¼?
- SektÃ¶rde master'Ä±n deÄŸeri nedir? (gerÃ§ekÃ§i deÄŸerlendirme)

## 2ï¸âƒ£ DETAYLI SENARYO KARÅžILAÅžTIRMASI (5+ Senaryo)

Her senaryo iÃ§in:
- Toplam maliyet (tuition + yaÅŸam + fÄ±rsat maliyeti)
- BaÅŸlangÄ±Ã§ maaÅŸÄ± (master sonrasÄ±)
- {years_left} yÄ±l toplam kazanÃ§
- NPV (discount %5)
- ROI (%)
- {profile.dream_job}'a kaÃ§ yÄ±lda ulaÅŸÄ±r
- FIRE hedefine ({years_left} yÄ±l) etki

### Senaryo 1: Master YOK - Direkt Ä°ÅŸe
- Avantajlar / Dezavantajlar
- Hesaplamalar

### Senaryo 2: TÃ¼rkiye Devlet Master (Ãœcretsiz)
- Hangi Ã¼niversiteler (en iyi 3-5)
- Avantajlar / Dezavantajlar
- Hesaplamalar

### Senaryo 3: TÃ¼rkiye Ã–zel Master ($5-15K)
- Hangi programlar (somut Ã¶neriler)
- Avantajlar / Dezavantajlar
- Hesaplamalar

### Senaryo 4: Avrupa Master ($15-30K)
- Hangi Ã¼lkeler/programlar (budget-friendly)
- Almanya (Ã¼cretsiz), Hollanda, Ä°sveÃ§, vs.
- Avantajlar / Dezavantajlar
- Hesaplamalar

### Senaryo 5: ABD/Ä°ngiltere Top Programs ($60K+)
- Hangi programlar (Ã¶zellikle {profile.masters_specific_programs} varsa deÄŸerlendir)
- Burs imkanlarÄ±
- Avantajlar / Dezavantajlar
- Hesaplamalar

### Senaryo 6: Online/Part-time Master
- Hangi programlar (Georgia Tech OMSCS, UT Austin, vs.)
- Avantajlar / Dezavantajlar
- Hesaplamalar

## 3ï¸âƒ£ SOMUT PROGRAM Ã–NERÄ°LERÄ°

Senin profiline gÃ¶re EN UYGUN 5-7 PROGRAM:

Her program iÃ§in:
- **Program AdÄ± & Ãœniversite**
- **Lokasyon & Åžehir**
- **SÃ¼re** (1 yÄ±l / 2 yÄ±l / part-time)
- **Toplam Maliyet** (gerÃ§ekÃ§i)
- **Kabul ÅžansÄ±n** (dÃ¼ÅŸÃ¼k/orta/yÃ¼ksek + neden)
- **GÃ¼Ã§lÃ¼ YÃ¶nleri** (kariyer, network, lokasyon)
- **ZayÄ±f YÃ¶nleri**
- **ROI Skoru** (/10)
- **Sana Uygunluk Skoru** (/10)
- **Application Deadline** (yaklaÅŸÄ±k)

Ã–rnek format:
### Program 1: ODTÃœ Bilgisayar MÃ¼hendisliÄŸi MS
- **Lokasyon**: Ankara, TÃ¼rkiye
- **SÃ¼re**: 2 yÄ±l (thesis)
- **Maliyet**: ~$3K
- **Kabul ÅžansÄ±**: YÃ¼ksek (aynÄ± Ã¼niversite)
- **GÃ¼Ã§lÃ¼**: Prestij, network, araÅŸtÄ±rma imkanÄ±
- **ZayÄ±f**: Uzun sÃ¼re, dÃ¼ÅŸÃ¼k maaÅŸ artÄ±ÅŸÄ±
- **ROI**: 7/10
- **Uygunluk**: 8/10

## 4ï¸âƒ£ DETAYLI FÄ°NANSAL TABLO

| Senaryo | Maliyet | BaÅŸlangÄ±Ã§ MaaÅŸ | 5Y Toplam | 10Y Toplam | NPV | ROI | FIRE'a Etki |
|---------|---------|-----------------|-----------|------------|-----|-----|-------------|
| 1. Ä°ÅŸ   | $0      | $40K           | ?         | ?          | ?   | -   | ?           |
| 2. TR Devlet | $3K | $48K          | ?         | ?          | ?   | ?%  | ?           |
| 3. TR Ã–zel | $12K  | $52K           | ?         | ?          | ?   | ?%  | ?           |
| 4. Avrupa | $25K   | $65K           | ?         | ?          | ?   | ?%  | ?           |
| 5. ABD | $70K      | $85K           | ?         | ?          | ?   | ?%  | ?           |
| 6. Online | $10K   | $45K           | ?         | ?          | ?   | ?%  | ?           |

## 5ï¸âƒ£ SENÄ°N ENDÄ°ÅžELERÄ°NE CEVAP

EndiÅŸeler: {profile.masters_concerns}

Her endiÅŸeyi TEK TEK ele al ve Ã§Ã¶zÃ¼m Ã¶ner.

## 6ï¸âƒ£ NET TAVSÄ°YE & KARAR AÄžACI

### EÄžER {profile.masters_priority} Ã¶nceliÄŸiyse:
â†’ Hangi senaryo/program?
â†’ Neden bu?
â†’ NasÄ±l baÅŸvurulur?
â†’ Finanse nasÄ±l edilir?

### ALTERNATÄ°F PLAN:
EÄŸer en iyi seÃ§enek olmazsa, Plan B nedir?

### ZAMAN Ã‡Ä°ZELGESÄ°:
- Åžimdi - 3 ay: ?
- 3-6 ay: ?
- 6-12 ay: ?
- Application dÃ¶nemleri

### SON SÃ–Z:
1 paragraf, NET karar: Master yap/yapma + hangi program + neden?

Max 100 satÄ±r. DETAYLI, SOMUT, UYGULANABILIR.
GerÃ§ek program adlarÄ±, Ã¼niversiteler, ÅŸehirler kullan.
Hesaplamalar GERÃ‡EKÃ‡I olsun."""

    return call_ai(prompt, system)

def analyze_fire(profile: UserProfile) -> str:
    """Generate FIRE plan"""
    system = "Sen FIRE hareketi uzmanÄ±sÄ±n. KararsÄ±z insanlara GERÃ‡EKÃ‡I ve UYGULANABILIR emeklilik planlarÄ± yapÄ±yorsun."

    current_age = int(profile.age)
    retire_age = int(profile.retire_age)
    years = retire_age - current_age

    prompt = f"""KÄ°ÅžÄ°YE Ã–ZEL FIRE PLANI (Markdown):

{profile.name}: {current_age} â†’ {retire_age} yaÅŸ ({years} yÄ±l)
Hedef: ${profile.target_portfolio}, Pasif gelir: ${profile.passive_income_goal}/ay
Neden: {profile.why_fire}, YaÅŸam: {profile.retirement_lifestyle}

## 1ï¸âƒ£ GerÃ§ekÃ§ilik Testi
- ${profile.target_portfolio} hedefi {years} yÄ±lda gerÃ§ekÃ§i mi?
- Riskler neler?

## 2ï¸âƒ£ AylÄ±k Birikim PlanÄ±
- Mevcut maaÅŸla: ?
- Hedef maaÅŸla: ?
- Tasarruf oranÄ±: %?

## 3ï¸âƒ£ YatÄ±rÄ±m Stratejisi
Risk: {profile.risk_tolerance}
- Hisse/ETF: %?
- Tahvil: %?
- Emlak: %?
- Platformlar: ?

## 4ï¸âƒ£ YÄ±llÄ±k Milestone'lar
| YÄ±l | YaÅŸ | Birikim | NasÄ±l? |
|-----|-----|---------|--------|
| ... | ... | ... | ... |

## 5ï¸âƒ£ Gelir ArtÄ±rma
- Ana iÅŸ projeksiyonu
- Yan gelir hedefi
- Yan gelir ÅŸart mÄ±?

## 6ï¸âƒ£ Harcama Optimizasyonu
- Åžu an: ${profile.monthly_expenses}
- Optimize: ?
- Kesinti alanlarÄ±

## 7ï¸âƒ£ Acil Durum PlanlarÄ±
- Bear market
- Ä°ÅŸ kaybÄ±
- SaÄŸlÄ±k

## 8ï¸âƒ£ Ä°lk 30 GÃ¼n AksiyonlarÄ±
5 somut adÄ±m

## 9ï¸âƒ£ BaÅŸarÄ± OlasÄ±lÄ±ÄŸÄ±
- Mevcut: %?
- TÃ¼m Ã¶nerilerle: %?
- Sebep

Max 60 satÄ±r."""

    return call_ai(prompt, system)

def analyze_side_hustle(profile: UserProfile) -> str:
    """Generate side hustle strategies"""
    system = "Sen giriÅŸimcilik ve yan gelir danÄ±ÅŸmanÄ±sÄ±n. KararsÄ±z insanlara SOMUT, UYGULANABILIR yan iÅŸ fikirleri veriyorsun."

    prompt = f"""KÄ°ÅžÄ°YE Ã–ZEL YAN GELÄ°R STRATEJÄ°LERÄ° (Markdown):

{profile.name}, {profile.age} yaÅŸ
Beceriler: {profile.programming_langs}, ML: {profile.ml_exp} yÄ±l
HaftalÄ±k: {profile.weekly_hours} saat, GiriÅŸimci: {profile.entrepreneurial}/10

## 5 Strateji (Kolay â†’ Zor)

### 1. Freelance/KonsÃ¼ltasyon
- **Ne yapacak**: ?
- **Gelir**: Ä°lk ay $?, 6.ay $?, 1.yÄ±l $?
- **Zaman**: BaÅŸlangÄ±Ã§ ?, haftalÄ±k ?
- **Maliyet**: $?
- **Uygunluk**: ?/10
- **Ä°lk 30 gÃ¼n**: Hafta 1-4 planÄ±
- **BaÅŸarÄ± ÅŸansÄ±**: %?

### 2-5. [DiÄŸer stratejiler aynÄ± formatta]

## NET TAVSÄ°YE
- Hangisiyle baÅŸlamalÄ±?
- Neden?
- Ä°lk 7 gÃ¼n yapÄ±lacaklar
- 6 ay hedef gelir
- FIRE'a etki

Max 80 satÄ±r."""

    return call_ai(prompt, system)

# ============ API ENDPOINTS ============

@app.get("/")
async def root():
    return {
        "message": "FIRE Planning API",
        "version": "1.0.0",
        "endpoints": {
            "health": "/health",
            "analyze": "/api/analyze (POST)"
        }
    }

@app.get("/health")
async def health():
    """Health check"""
    return {
        "status": "healthy",
        "groq_api_configured": bool(os.getenv('GROQ_API_KEY'))
    }

@app.post("/api/analyze", response_model=AnalysisResponse)
async def analyze(request: AnalysisRequest):
    """
    Generate AI analysis based on user profile

    analysis_type: "career" | "roi" | "fire" | "side_hustle"
    """
    from datetime import datetime

    analysis_funcs = {
        "career": analyze_career,
        "roi": analyze_roi,
        "fire": analyze_fire,
        "side_hustle": analyze_side_hustle
    }

    if request.analysis_type not in analysis_funcs:
        raise HTTPException(
            status_code=400,
            detail=f"Invalid analysis_type. Must be one of: {list(analysis_funcs.keys())}"
        )

    try:
        analysis = analysis_funcs[request.analysis_type](request.profile)

        return AnalysisResponse(
            analysis=analysis,
            analysis_type=request.analysis_type,
            timestamp=datetime.now().isoformat()
        )
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

@app.post("/api/analyze-all")
async def analyze_all(profile: UserProfile):
    """
    Generate all 4 analyses at once
    Returns: {career, roi, fire, side_hustle}
    """
    from datetime import datetime

    try:
        results = {
            "career": analyze_career(profile),
            "roi": analyze_roi(profile),
            "fire": analyze_fire(profile),
            "side_hustle": analyze_side_hustle(profile),
            "timestamp": datetime.now().isoformat()
        }
        return results
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=8000)
